<link href="https://cdn.jsdelivr.net/npm/jquery-resizable-columns@0.2.3/dist/jquery.resizableColumns.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.6/dist/bootstrap-table.min.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/table.css">
<link rel="stylesheet" href="/static/css/form.css">

<html lang="en">
  <%- include('./partials/head',{title: `${request.body.serverHost} - Dashboard`}); %>
  <body class="d-flex flex-column h-100">
    <%- include('./partials/navbar', {active:'dashboard'}); %>
    <main class="pb-1">
      <div class="text-center">
        <h1 class="display-1 mt-2 gradient-text">Dashboard</h1>
      </div>
      <p class="text-center mt-2 display-6 ">Welcome <%= request.session.metadata.display_name %>, this is the status of your server today</p>
      <div class= "container-fluid mt-5">
        <div class="row">
          <% 
            const modules = [
              { name: 'nostraddressData', icon: 'doughnut', dashcardName: 'Registered users', link: '#nostraddressData', dataKey: 'nostraddressData' },
              { name: 'mediaData', icon: 'doughnut', dashcardName: 'Media files', link: '#mediaData', dataKey: 'mediaData' },
              { name: 'lightningData', icon: 'chart', dashcardName: 'Lightning redirects', link: '#lightningData', dataKey: 'lightningData' },
              { name: 'domainsData', icon: 'chart', dashcardName: 'Domains', link: '#domainsData', dataKey: 'domainsData' },
              { name: 'logHistory', icon: 'warning', dashcardName: 'Warning messages', link: 'settings/#settingsLogger', dataKey: 'logHistory' },
              { name: 'paymentsData', icon: 'doughnut', dashcardName: 'Transactions', link: '#paymentsData', dataKey: 'paymentsData' },
              { name: 'unpaidTransactionsBalance', icon: 'satoshi', dashcardName: 'Unpaid transactions balance', link: '#paymentsData', dataKey: 'paymentsData' },
              { name: 'serverBalance', icon: 'satoshi', dashcardName: 'Server balance', link: '', dataKey: 'paymentsData' }
            ];
        
            modules.forEach(module => {
              const dataKey = module.dataKey;
              const data = request.body[module.name] || [];
              console.log(data)
              if (request.body.activeModules.includes(module.dataKey)) {
                %>
                  <%- include('./components/dashcard', {icon: module.icon, dashcardName: module.dashcardName, data: data, link: module.link, dataKey : module.dataKey}); %>
                <%
              }
            });
          %>
        </div>
      </div>
      <div class= "container-fluid mt-4">
        <div class="row mt-5">
          <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
            <canvas id="nostraddressData-chart"> </canvas>
          </div>
          <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
            <canvas id="mediaData-chart" class="col-xl-3 col-lg-4 col-md-12 col-sm-12"></canvas>
          </div>
      </div> 
      <div class="container-fluid mt-4 mb-5 overflow-auto ">
          <%- include('./components/table', {
                                        tableName:"Registered users", 
                                        tableId:"nostraddressData", 
                                        buttons:[
                                                ['add','show'],
                                                ['disable','show'],
                                                ['enable','show'],
                                                ['visible','hide'],
                                                ['invisible','hide'],
                                                ['admin','show'],
                                                ['edit','show'],
                                                ['password','show'],
                                                ['remove','show'],
                                                ['pay','show'],
                                                ['balance','show']
                                                ],
                                        fields:[
                                                ['checked','enabled','show','formatCheckbox', 'text-center'],
                                                ['active','enabled','show','formatCheckbox', 'text-center'],
                                                ['allowed','enabled','show','formatCheckbox', 'text-center'],
                                                ['username','enabled','show'],
                                                ['balance', 'disabled', 'show','formatSatoshi', 'text-end'],
                                                ['pubkey','enabled','show', 'formatPubkey', ''],
                                                ['hex','enabled','hide', 'formatPubkey', ''],
                                                ['domain','enabled','show', '', 'text-center'],
                                                ['comments','enabled','hide'],
                                                ['date','disabled','show','', 'text-center'],
                                                ['transactionid', 'disabled', 'hide']
                                                ]
                                        }); %>
          <%- include('./components/table', {
                                        tableName:"Media files", 
                                        tableId:"mediaData", 
                                        buttons:[
                                                ['add','hide'],
                                                ['disable','show'],
                                                ['enable','show'],      
                                                ['visible','show'],
                                                ['invisible','show'],                                        
                                                ['admin','hide'],
                                                ['edit','show'],
                                                ['password','hide'],
                                                ['remove','show'],
                                                ['pay','show'],
                                                ['balance','hide']
                                                ],
                                        fields:[
                                                ['checked','enabled','show','formatCheckbox', 'text-center'],
                                                ['active','enabled','show','formatCheckbox', 'text-center'],
                                                ['visibility','enabled','show','formatCheckbox','text-center'],
                                                ['paid', 'disabled','show','formatCheckbox','text-center'],
                                                ['satoshi', 'disabled','show','formatSatoshi','text-end'],
                                                ['username','disabled','show', '', 'text-center'],
                                                ['npub','disabled','hide'],
                                                ['pubkey','disabled','hide'],
                                                ['filename','disabled','show', 'formatFilename', ''],
                                                ['original_hash','disabled','hide'],
                                                ['hash','disabled','hide'],
                                                ['status','disabled','show','', 'text-center'],
                                                ['dimensions','disabled','show', '', 'text-center'],
                                                ['filesize','disabled','show', '', 'text-center'],
                                                ['date','disabled','show', '', 'text-center'],
                                                ['comments','enabled','hide'],
                                                ['transactionid', 'disabled', 'hide']                                                
                                                ]
                                        }); %>
          <%- include('./components/table', {
                                          tableName:"Lightning redirects", 
                                          tableId:"lightningData", 
                                          buttons:[
                                            ['add','show'],
                                            ['disable','show'],
                                            ['enable','show'],
                                            ['visible','hide'],
                                            ['invisible','hide'],
                                            ['admin','hide'],
                                            ['edit','show'],
                                            ['password','hide'],
                                            ['remove','show'],
                                            ['pay','show'],
                                            ['balance','hide']
                                          ],
                                          fields:[
                                          ['active','enabled','show','formatCheckbox', 'text-center'],
                                          ['pubkey','enabled','show'],
                                          ['lightningaddress','enabled','show'],
                                          ['comments','enabled','show'],
                                          ['transactionid', 'disabled', 'hide']
                                          ]
                                          }); %>
          <%- include('./components/table', {
                                          tableName:"Domains", 
                                          tableId:"domainsData", 
                                          buttons:[
                                            ['add','show'],
                                            ['disable','show'],
                                            ['enable','show'],
                                            ['visible','hide'],
                                            ['invisible','hide'],
                                            ['admin','hide'],
                                            ['edit','show'],
                                            ['password','hide'],
                                            ['remove','show'],
                                            ['pay', 'hide'],
                                            ['balance','hide']
                                          ],
                                          fields:[
                                          ['active','enabled','show','formatCheckbox', 'text-center'],
                                          ['domain','enabled','show','','text-center'],
                                          ['comments','enabled','show']
                                          ]
                                          }); %> 
            <%- include('./components/table', {
                                          tableName:"Transactions", 
                                          tableId:"paymentsData", 
                                          buttons:[
                                            ['add','hide'],
                                            ['disable','hide'],
                                            ['enable','hide'],
                                            ['visible','hide'],
                                            ['invisible','hide'],
                                            ['admin','hide'],
                                            ['edit','show'],
                                            ['password','hide'],
                                            ['remove','hide'],
                                            ['pay', 'show'],
                                            ['balance','hide']
                                          ],
                                          fields:[
                                          ['accountid','disabled','show'],
                                          ['type', 'disabled', 'show'],
                                          ['paymentrequest', 'disabled', 'hide'],
                                          ['paymenthash','disabled','show'],
                                          ['paid', 'disabled', 'show', 'formatCheckbox', 'text-center'],
                                          ['satoshi', 'disabled','show','formatSatoshi','text-end'],
                                          ['createddate','disabled','show', '', 'text-center'],
                                          ["expirydate", 'disabled', 'show', '', 'text-center'],
                                          ['paiddate', 'disabled', 'show', '', 'text-center'],
                                          ['comments','enabled','show']
                                          ]
                                          }); %> 
      </div>
     </main>
    <%- include('./partials/footer'); %>        
                           
  </body>

<!-- Tables data -->
  <script src="/static/js/table.js"></script>
  <script>
    let authkey = "<%= request.session.authkey %>"
    let metadata = <%- JSON.stringify(request.session.metadata) %>
    if("<%- request.body.nostraddressData && request.body.nostraddressData.length > 0 %>"){
      initTable("#nostraddressData",'<%- request.body.nostraddressData %>','user')
    }
    if("<%- request.body.mediaData && request.body.mediaData.length > 0 %>"){
      initTable("#mediaData",'<%- request.body.mediaData %>', 'media file')
    }
    if("<%- request.body.lightningData && request.body.lightningData.length > 0 %>"){
      initTable("#lightningData",'<%- request.body.lightningData %>', 'lightning redirection')
    }
    if("<%- request.body.domainsData && request.body.domainsData.length > 0 %>"){
      initTable("#domainsData",'<%- request.body.domainsData %>', 'domain name')
    }
    if("<%- request.body.paymentsData && request.body.paymentsData.length > 0 %>"){
      initTable("#paymentsData",'<%- request.body.paymentsData %>', 'transaction')
    }
  </script>

<!-- Charts data -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/chart.js"></script>
<script>
  if("<%- JSON.stringify(request.body.nostraddressData && request.body.nostraddressData.length > 0 ) %>"){
    initMonthChart("#nostraddressData-chart",'Registered users','<%- request.body.nostraddressData %>')
  }
  if("<%- JSON.stringify(request.body.mediaData && request.body.mediaData.length > 0 ) %>"){
    initMonthChart("#mediaData-chart",'Media files','<%- request.body.mediaData %>')
  }
  if("<%- JSON.stringify(request.body.paymentsData && request.body.paymentsData.length > 0 ) %>"){
    initMonthChart("#paymentsData-chart",'Transactions','<%- request.body.paymentsData %>')
  }
  if("<%- JSON.stringify(request.body.nostraddressData && request.body.nostraddressData.length > 0 ) %>"){
    initDoughnutChart("#nostraddressData-dashcard-doughnut",'Checked users','<%- request.body.nostraddressData %>', 'checked')
  }
  if("<%- JSON.stringify(request.body.mediaData && request.body.mediaData.length > 0 ) %>"){
    initDoughnutChart("#mediaData-dashcard-doughnut",'Checked media files','<%- request.body.mediaData %>', 'checked')
  }
  if("<%- JSON.stringify(request.body.paymentsData && request.body.paymentsData.length > 0 ) %>"){
    initDoughnutChart("#paymentsData-dashcard-doughnut",'Paid transactions','<%- request.body.paymentsData %>', 'paid')
  }
</script>
</html>
