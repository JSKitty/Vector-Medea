<link href="https://cdn.jsdelivr.net/npm/jquery-resizable-columns@0.2.3/dist/jquery.resizableColumns.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.6/dist/bootstrap-table.min.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/table.css">
<link rel="stylesheet" href="/static/css/form.css">

<html lang="en">
  <%- include('./partials/head',{title: `${request.body.serverHost} - Dashboard`}); %>
  <body class="d-flex flex-column h-100">
    <%- include('./partials/navbar', {active:'dashboard'}); %>
    <main class="pb-1">
      <div class="text-center">
        <h1 class="display-1 mt-2 gradient-text">Dashboard</h1>
      </div>
      <p class="text-center mt-2 display-6 ">Welcome <%= request.session.metadata.display_name %>, this is the status of your server today</p>
      <div class= "container-fluid mt-5">
        <div class="row">
          <% 
            const modules = [
              { name: 'nostraddressCount', icon: 'doughnut', dashcardName: 'Registered users', link: '#nostraddressData', dataKey: 'nostraddress' },
              { name: 'mediaCount', icon: 'doughnut', dashcardName: 'Media files', link: '#mediaData', dataKey: 'media' },
              { name: 'lightningCount', icon: 'chart', dashcardName: 'Lightning redirects', link: '#lightningData', dataKey: 'lightning' },
              { name: 'domainsCount', icon: 'chart', dashcardName: 'Domains', link: '#domainsData', dataKey: 'domains' },
              { name: 'logHistory', icon: 'warning', dashcardName: 'Warning messages', link: 'settings/#settingsLogger', dataKey: 'logHistory' },
              { name: 'paymentsCount', icon: 'doughnut', dashcardName: 'Transactions', link: '#paymentsData', dataKey: 'payments'},
              { name: 'unpaidTransactionsBalance', icon: 'satoshi', dashcardName: 'Unpaid transactions balance', link: '#paymentsData', dataKey: 'payments' },
              { name: 'serverBalance', icon: 'satoshi', dashcardName: 'Server balance', link: '', dataKey: 'payments' }
            ];
        
            modules.forEach(module => {
              const dataKey = module.dataKey;
              let data = request.body[module.name] || [];
              if (request.body.activeModules.includes(module.dataKey)) {
                %>
                  <%- include('./components/dashcard', {icon: module.icon, dashcardName: module.dashcardName, data: data, link: module.link, dataKey : module.dataKey}); %>
                <%
              }
            });
          %>
        </div>
      </div>
      <div class="container-fluid mt-4 mb-5 overflow-auto ">
        <% 
        let nostraddressFields = [
          ['checked','enabled','show','formatCheckbox', 'text-center','30'],
          ['active','enabled','show','formatCheckbox', 'text-center','30'],
          ['allowed','enabled','show','formatCheckbox', 'text-center','30'],
          ['username','enabled','show'],
          ['pubkey','enabled','show', 'formatPubkey', ''],
          ['hex','enabled','hide', 'formatPubkey', ''],
          ['domain','enabled','show', '', 'text-center'],
          ['comments','enabled','hide'],
          ['date','disabled','show','', 'text-center', '290'],

        ];

        if (request.body.activeModules.includes("payments")) {
          nostraddressFields.splice(4, 0, ['balance', 'disabled', 'show','formatSatoshi', 'text-end','40'],);
          nostraddressFields.splice(5, 0, ['transactionid', 'disabled', 'hide']);
        }
        %>
        <%- include('./components/table', {
          tableName:"Registered users", 
          tableId:"nostraddressData", 
          buttons:[
                  ['add','show'],
                  ['disable','show'],
                  ['enable','show'],
                  ['visible','hide'],
                  ['invisible','hide'],
                  ['admin','show'],
                  ['edit','show'],
                  ['password','show'],
                  ['remove','show'],
                  ['pay','show'],
                  ['balance','show']
                  ],
          fields: nostraddressFields
        }); %>
        <div class= "container-fluid mt-2 justify-content-center align-items-center d-flex">
          <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
            <canvas id="nostraddressData-chart"> </canvas>
          </div>
          <div class= "container-fluid mt-2 justify-content-center align-items-center d-flex">
            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
              <canvas id="nostraddressData-doughnut"></canvas>
            </div>
          </div>
        </div>
        <% 
        let mediaFields = [
          ['checked','enabled','show','formatCheckbox', 'text-center','30'],
          ['active','enabled','show','formatCheckbox', 'text-center','30'],
          ['visibility','enabled','show','formatCheckbox','text-center','30'],
          ['username','disabled','show', '', 'text-center','50'],
          ['npub','disabled','hide'],
          ['pubkey','disabled','hide'],
          ['filename','disabled','show', 'formatFilename', ''],
          ['original_hash','disabled','hide'],
          ['hash','disabled','hide'],
          ['status','disabled','show','', 'text-center','50'],
          ['dimensions','disabled','show', '', 'text-center','40'],
          ['filesize','disabled','show', '', 'text-center','40'],
          ['date','disabled','show', '', 'text-center','290'],
          ['comments','enabled','hide'],
        ];

        if (request.body.activeModules.includes("payments")) {
          mediaFields.splice(3, 0, ['paid', 'disabled','show','formatCheckbox','text-center','30'],);
          mediaFields.splice(4, 0, ['satoshi', 'disabled','show','formatSatoshi','text-end','30'],);
          mediaFields.splice(5, 0, ['transactionid', 'disabled', 'hide']);
        }

        %>
        <% if(request.body.activeModules.includes('media')) { %> 
          <%- include('./components/table', {
            tableName:"Media files", 
            tableId:"mediaData", 
            buttons:[
                    ['add','hide'],
                    ['disable','show'],
                    ['enable','show'],      
                    ['visible','show'],
                    ['invisible','show'],                                        
                    ['admin','hide'],
                    ['edit','show'],
                    ['password','hide'],
                    ['remove','show'],
                    ['pay','show'],
                    ['balance','hide']
                    ],
            fields: mediaFields
          }); %>
          <div class= "container-fluid mt-2 justify-content-center align-items-center d-flex">
            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
              <canvas id="mediaData-chart"></canvas>
            </div>
            <div class= "container-fluid mt-2 justify-content-center align-items-center d-flex">
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                <canvas id="mediaData-doughnut"></canvas>
              </div>
            </div>
          </div>
        <% } %>
        <%
        let lightningFields = [
          ['active','enabled','show','formatCheckbox', 'text-center','30'],
          ['pubkey','enabled','show','40'],
          ['lightningaddress','enabled','show','40'],
          ['comments','enabled','show'],
         
        ];
        if (request.body.activeModules.includes("payments")) {
          lightningFields.splice(5, 0,  ['transactionid', 'disabled', 'hide']);
        }
        %>
        <% if(request.body.activeModules.includes('lightning')) { %> 
          <%- include('./components/table', {
            tableName:"Lightning redirects", 
            tableId:"lightningData", 
            buttons:[
              ['add','show'],
              ['disable','show'],
              ['enable','show'],
              ['visible','hide'],
              ['invisible','hide'],
              ['admin','hide'],
              ['edit','show'],
              ['password','hide'],
              ['remove','show'],
              ['pay','show'],
              ['balance','hide']
            ],
            fields: lightningFields
          }); %> 
        <% } %>
        <%
        let domainsFields = [
          ['active','enabled','show','formatCheckbox', 'text-center','30'],
          ['domain','enabled','show','','text-center','40'],
          ['comments','enabled','show']
        ];
        %>
        <% if(request.body.activeModules.includes('domains')) { %> 
          <%- include('./components/table', {
            tableName:"Domains", 
            tableId:"domainsData", 
            buttons:[
              ['add','show'],
              ['disable','show'],
              ['enable','show'],
              ['visible','hide'],
              ['invisible','hide'],
              ['admin','hide'],
              ['edit','show'],
              ['password','hide'],
              ['remove','show'],
              ['pay', 'hide'],
              ['balance','hide']
            ],
            fields: domainsFields
            }); %> 
          <% } %>
          <%
          let paymentsFields = [
            ['accountid','disabled','show', '', 'text-center','40'],
            ['type', 'disabled', 'show', '', 'text-center','40'],
            ['paymentrequest', 'disabled', 'hide'],
            ['paymenthash','disabled','show'],
            ['paid', 'disabled', 'show', 'formatCheckbox', 'text-center','30'],
            ['satoshi', 'disabled','show','formatSatoshi','text-end','30'],
            ['createddate','disabled','show', '', 'text-center','150'],
            ["expirydate", 'disabled', 'hide', '', 'text-center','150'],
            ['paiddate', 'disabled', 'show', '', 'text-center','150'],
            ['comments','enabled','show']
          ];
          %>
          <% if(request.body.activeModules.includes('payments')) { %> 
           <%- include('./components/table', {
              tableName:"Transactions", 
              tableId:"paymentsData", 
              buttons:[
                ['add','hide'],
                ['disable','hide'],
                ['enable','hide'],
                ['visible','hide'],
                ['invisible','hide'],
                ['admin','hide'],
                ['edit','show'],
                ['password','hide'],
                ['remove','hide'],
                ['pay', 'show'],
                ['balance','hide']
              ],
              fields: paymentsFields
              }); %> 
            <% } %>
          <div class= "container-fluid mt-2 justify-content-center align-items-center d-flex">
            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
              <canvas id="paymentsData-chart"></canvas>
            </div>
            <div class= "container-fluid mt-2 justify-content-center align-items-center d-flex">
              <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                <canvas id="paymentsData-doughnut"></canvas>
              </div>
            </div>
          </div>
      </div>
     </main>
    <%- include('./partials/footer'); %>        
                           
  </body>

<!-- Tables data -->
  <script src="/static/js/table.js"></script>
  <script>
    let authkey = "<%= request.session.authkey %>"
    let metadata = <%- JSON.stringify(request.session.metadata) %>

    async function initTablesSequentially() {
        await initTable("#nostraddressData", 'admin/moduledata?module=nostraddress', 'user');
        await initTable("#mediaData", 'admin/moduledata?module=media', 'media file');
        await initTable("#lightningData", 'admin/moduledata?module=lightning', 'lightning redirection');
        await initTable("#domainsData", 'admin/moduledata?module=domains', 'domain name');
        await initTable("#paymentsData", 'admin/moduledata?module=payments', 'transaction');
    }
    initTablesSequentially();
    setInterval(() => {
      refreshTables(["#nostraddressData", 
                     "#mediaData", 
                     "#lightningData", 
                     "#domainsData", 
                     "#paymentsData"], 
                     ['admin/moduledata?module=nostraddress', 
                     'admin/moduledata?module=media', 
                     'admin/moduledata?module=lightning', 
                     'admin/moduledata?module=domains', 
                     'admin/moduledata?module=payments'])
    },60000);
  </script>

<!-- Charts data -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/chart.js"></script>
<script>
  if("<%- JSON.stringify(request.body.activeModules.includes('nostraddress')) %>"){
    // initMonthChart("#nostraddressData-chart",'Registered users','<%- request.body.nostraddressData %>')
    initDoughnutChart("#nostraddressData-doughnut",'Checked registered users','<%- request.body.nostraddressCheckedCount %>', 'checked', true, false)
    initDoughnutChart("#nostraddressData-dashcard-doughnut",'Checked users','<%- request.body.nostraddressCheckedCount %>', 'checked')
  }
  if("<%- JSON.stringify(request.body.activeModules.includes('media')) %>"){
    // initMonthChart("#mediaData-chart",'Media files','<%- request.body.mediaData %>')
    initDoughnutChart("#mediaData-doughnut",'Checked media files','<%- request.body.mediaCheckedCount %>', 'checked', true, false)
    initDoughnutChart("#mediaData-dashcard-doughnut",'Checked media files','<%- request.body.mediaCheckedCount %>', 'checked')
  }
  if("<%- JSON.stringify(request.body.activeModules.includes('payments')) %>"){
    // initMonthChart("#paymentsData-chart",'Transactions','<%- request.body.paymentsData %>')
    initDoughnutChart("#paymentsData-doughnut",'Paid transactions','<%- request.body.paymentsPaidCount %>', 'paid', true, false)
    initDoughnutChart("#paymentsData-dashcard-doughnut",'Paid transactions','<%- request.body.paymentsPaidCount %>', 'paid')
  }
</script>
</html>