<% 
  const {
    type, name, label, description, value, required,
    options, alert, globalValue, overridable, placeholder
  } = typeof locals !== 'undefined' ? locals : {};

  const selectedDomain = locals?.selectedDomain || null;
  const isGlobal = !selectedDomain;
  const isOverridable = overridable !== false;
  const keyParts = name.split(".");
  const localKeys = locals.domainConfig?.[keyParts[0]];
  const hasOwnValue = localKeys && Object.prototype.hasOwnProperty.call(localKeys, keyParts[1]);
  const effectiveOverride = hasOwnValue && isOverridable && !isGlobal;
  const shouldDisable = !isGlobal && !isOverridable;
  const effectiveValue = (value !== undefined) ? value : globalValue;


%>
<% const inputClass = `form-control${shouldDisable ? ' bg-light text-muted' : ''}`; %>
<% const selectClass = `form-select${shouldDisable ? ' bg-light text-muted' : ''}`; %>

<div class="form-group mt-3">
  <% if (label) { %>
    <label for="<%= name %>" class="fw-bold">
      <%= label %>
      <% if (!isGlobal && isOverridable) { %>
        <span id="badge-<%= name %>" class="badge <%= effectiveOverride && globalValue !== value ? 'bg-success' : 'bg-info' %> ms-2">
          <%= effectiveOverride && globalValue !== value ? 'Overridden' : 'Inherited' %>
        </span>
      <% } %>
      <% if (shouldDisable) { %>
        <span class="badge bg-secondary ms-2">Read-only</span>
      <% } %>
    </label>
  <% } %>

  <% if (description) { %>
    <p><%= description %></p>
  <% } %>

  <% if (type === "text" || type === "number") { %>
    <input 
      type="<%= type %>" 
      class="<%= inputClass %>" 
      name="<%= name %>" 
      id="<%= name %>" 
      value="<%= effectiveValue %>" 
      defaultValue="<%= effectiveValue %>" 
      data-global-value="<%= globalValue %>"
      placeholder="<%= placeholder %>"
      <%= required ? "required" : "" %>
      <%= shouldDisable ? "disabled" : "" %> >

  <% } else if (type === "password") { %>
    <div class="input-group">
      <input 
        type="password" 
        class="<%= inputClass %> mb-2" 
        name="<%= name %>" 
        id="<%= name %>" 
        value="<%= effectiveValue %>" 
        defaultValue="<%= effectiveValue %>" 
        data-global-value="<%= globalValue %>"
        placeholder="<%= placeholder || '••••••' %>"
        <%= required ? "required" : "" %>
        <%= shouldDisable ? "disabled" : "" %> >
      <button 
        type="button" 
        class="toggle-password d-none"
        aria-label="Show <%= label %> as plain text. Warning: this will display the text on the screen.">
      </button>
    </div>

  <% } else if (type === "checkbox") { %>
    <div class="form-check form-switch">
      <input 
        class="form-check-input" 
        type="checkbox" 
        name="<%= name %>" 
        id="<%= name %>" 
        data-global-value="<%= globalValue ? 'true' : 'false' %>"
        <%= effectiveValue  ? "checked" : "" %> 
        <%= effectiveValue  ? "defaultChecked" : "" %>
        <%= shouldDisable ? "disabled" : "" %> >
    </div>

    <% } else if (type === "select") { %>
      <select
        class="<%= selectClass %>"
        name="<%= name %>"
        id="<%= name %>"
        data-global-value="<%= globalValue %>"
        <%= shouldDisable ? "disabled" : "" %>>
        <% options.forEach(opt => { %>
          <option 
            value="<%= opt.value %>" 
            <%= opt.value === effectiveValue ? "selected" : "" %> 
            <%= opt.value === effectiveValue ? "defaultSelected" : "" %>>
            <%= opt.label %>
          </option>
        <% }) %>
      </select>
    <% } %>

  <% if (alert) { %>
    <div class="alert alert-<%= alert.type || 'warning' %> mt-2" role="alert">
      <% if (alert.icon) { %><i class="fa-solid <%= alert.icon %> me-2"></i><% } %>
      <%- alert.message %> 
    </div>
  <% } %>
</div>
