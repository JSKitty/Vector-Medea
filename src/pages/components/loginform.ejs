<form class="form login-form" onkeydown=" if (event.keyCode === 13) {logIn('legacy', $('#rememberme:checked').val(),'submit');}">
    <div class="text-center">
      <h1 class="display-5 mb-2 pb-2 font-weight-normal gradient-text">Login</h1>
    </div>
    <label for="username" class="sr-only">Username</label>
    <input type="text" id="username" name="username" class="form-control mb-2" placeholder="Username" required autofocus>
    <label for="password" class="sr-only">Password</label>
    <div class="input-group">
      <input type="password" id="password"  name="password" class="form-control" placeholder="Password" >
      <button id="toggle-password" type="button" class="d-none"
        aria-label="Show password as plain text. Warning: this will display your password on the screen.">
      </button>
  </div>
    <div class="checkbox mb-3">
      <label>
        <input type="checkbox" value="true" id="rememberme" name="rememberme"> Remember me
      </label>
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-lg btn-primary" name="submit" id="submit" type="button" onclick="logIn('legacy', $('#rememberme:checked').val(),'submit')">Login</button>
      <hr class="hr "/>
      <button class="btn btn-lg btn-primary" name="NIP07_submit" id="NIP07_submit" type="button" onclick="logIn('nostr', $('#rememberme:checked').val(), 'NIP07_submit')"><i class="nostr-logo me-2"></i>Nostr login</button>
    </div>
</form>
<script src="/static/js/form.js"></script>
<script>
const logIn = async (type, rememberMe, buttonId) =>{

    console.debug('logIn', type, rememberMe, buttonId);
  const buttonText = document.getElementById(buttonId).innerHTML;
  document.getElementById(buttonId).innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Logging in...';

  if (type === 'legacy') {
      await fetchServer(JSON.stringify({username: document.getElementById('username').value, 
                                        password:  document.getElementById('password').value, 
                                        rememberMe: rememberMe}
                                      )).then(response => {
                                          if (response.status === 200) {
                                              response.json().then(data => {
                                                  if (data == true) {
                                                      window.location.href = "/api";
                                                  } else {
                                                      initAlertModal("#login", data.message);
                                                      document.getElementById(buttonId).innerHTML = buttonText;
                                                  }
                                              });
                                          } else {
                                              initAlertModal("#login", response.statusText);
                                              document.getElementById(buttonId).innerHTML = buttonText;
                                          }});
  }

  if (type === 'nostr') {
      if (!window.nostr) {
        initAlertModal("#login", 'NIP07 browser extension not found');
        document.getElementById(buttonId).innerHTML = buttonText;
        return;}
      try {
          const pubKey = await window.nostr.getPublicKey();

          if (!pubKey){console.debug('NIP07 public key not found');return;}

          let event = {
              kind: 30078,
              created_at: Math.floor(Date.now() / 1000),
              tags: [
                    ["cookie", 
                    rememberMe? "true": "false"]
                    ],
              content: 'This will not be published on nostr. Its purpose is to verify that you have control of your pubkey'
          };
          console.log(event);
          const loginEvent = JSON.stringify(await window.nostr.signEvent(event));

          if (loginEvent){
              await fetchServer(loginEvent).then(response => {
                  if (response.status === 200) {
                      response.json().then(data => {
                          if (data == true) {
                              window.location.href = "/api";
                          } else {
                              initAlertModal("#login", data.message);
                              document.getElementById(buttonId).innerHTML = buttonText;
                          }
                      });
                  } else {
                      initAlertModal("#login", response.statusText);
                      document.getElementById(buttonId).innerHTML = buttonText;
                  }
              });
          }
      } catch (error) {
          console.error(error);
          document.getElementById(buttonId).innerHTML = buttonText;
      }
  }
}

const fetchServer = async (data) => {
  try {
      const response = await fetch('login', {method: 'POST',headers: {'Content-Type': 'application/json'},body: data});
      return response;
  } catch (error) {
      initAlertModal("#login", error);
  }
}
</script>